{% extends "base.html" %}

{% block title %}çŸ¥è¯†åº“ç®¡ç† - å·¥ç¨‹æ–‡æ¡£æ™ºèƒ½è§£æä¸RAGé—®ç­”ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="text-primary fw-bold mb-1">ğŸ“š çŸ¥è¯†åº“ç®¡ç†</h2>
                    <p class="text-muted mb-0">ç®¡ç†å·¥ç¨‹æ–‡æ¡£çŸ¥è¯†åº“ï¼ŒæŸ¥çœ‹æ–‡æ¡£å’Œç»Ÿè®¡ä¿¡æ¯</p>
                </div>
                <div>
                    <button class="btn btn-outline-primary me-2" onclick="refreshKnowledgeBase()">
                        <i class="fas fa-sync-alt"></i> åˆ·æ–°
                    </button>
                    <button class="btn btn-primary" onclick="exportKnowledgeBase()">
                        <i class="fas fa-download"></i> å¯¼å‡º
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="col-md-3 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-primary mb-3">
                        <i class="fas fa-file-alt" style="font-size: 2.5rem;"></i>
                    </div>
                    <h3 class="fw-bold text-primary mb-1" id="totalDocuments">-</h3>
                    <p class="text-muted mb-0">æ€»æ–‡æ¡£æ•°</p>
                    <small class="text-success" id="documentsGrowth">-</small>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-success mb-3">
                        <i class="fas fa-puzzle-piece" style="font-size: 2.5rem;"></i>
                    </div>
                    <h3 class="fw-bold text-success mb-1" id="totalChunks">-</h3>
                    <p class="text-muted mb-0">çŸ¥è¯†ç‰‡æ®µ</p>
                    <small class="text-success" id="chunksGrowth">-</small>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-warning mb-3">
                        <i class="fas fa-database" style="font-size: 2.5rem;"></i>
                    </div>
                    <h3 class="fw-bold text-warning mb-1" id="storageSize">-</h3>
                    <p class="text-muted mb-0">å­˜å‚¨å¤§å°</p>
                    <small class="text-info" id="storageUsage">-</small>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-info mb-3">
                        <i class="fas fa-clock" style="font-size: 2.5rem;"></i>
                    </div>
                    <h3 class="fw-bold text-info mb-1" id="lastUpdated">-</h3>
                    <p class="text-muted mb-0">æœ€åæ›´æ–°</p>
                    <small class="text-muted" id="updateFrequency">-</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- æ–‡æ¡£åˆ—è¡¨ -->
        <div class="col-lg-8 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold mb-0">ğŸ“– æ–‡æ¡£åˆ—è¡¨</h5>
                        <div class="d-flex gap-2">
                            <select class="form-select form-select-sm" id="documentFilter" onchange="filterDocuments()">
                                <option value="">æ‰€æœ‰ç±»å‹</option>
                                <option value="technical_manual">æŠ€æœ¯æ‰‹å†Œ</option>
                                <option value="engineering_drawing">å·¥ç¨‹å›¾çº¸</option>
                                <option value="process_diagram">å·¥è‰ºæµç¨‹å›¾</option>
                                <option value="specification_sheet">æŠ€æœ¯è§„æ ¼è¡¨</option>
                            </select>
                            <div class="input-group input-group-sm" style="width: 200px;">
                                <input type="text" class="form-control" placeholder="æœç´¢æ–‡æ¡£..." id="documentSearch" onkeyup="searchDocuments()">
                                <button class="btn btn-outline-secondary" type="button">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="px-4 py-3">æ–‡æ¡£åç§°</th>
                                    <th class="px-4 py-3">ç±»å‹</th>
                                    <th class="px-4 py-3">é¢†åŸŸ</th>
                                    <th class="px-4 py-3">æ·»åŠ æ—¶é—´</th>
                                    <th class="px-4 py-3">çŠ¶æ€</th>
                                    <th class="px-4 py-3">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="documentsTableBody">
                                <!-- æ–‡æ¡£åˆ—è¡¨å°†åŠ¨æ€åŠ è½½ -->
                            </tbody>
                        </table>
                    </div>
                    <div id="noDocuments" class="text-center py-5" style="display: none;">
                        <div class="text-muted">
                            <i class="fas fa-folder-open" style="font-size: 3rem; opacity: 0.3;"></i>
                            <p class="mt-3 mb-0">æš‚æ— æ–‡æ¡£</p>
                            <small>è¯·å…ˆä¸Šä¼ ä¸€äº›å·¥ç¨‹æ–‡æ¡£</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- çŸ¥è¯†åº“ä¿¡æ¯ -->
        <div class="col-lg-4 mb-4">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="fw-bold mb-0">ğŸ“Š é¢†åŸŸåˆ†å¸ƒ</h5>
                </div>
                <div class="card-body">
                    <canvas id="domainChart" style="max-height: 200px;"></canvas>
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="fw-bold mb-0">ğŸ”§ çŸ¥è¯†åº“æ“ä½œ</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" onclick="rebuildIndex()">
                            <i class="fas fa-cog"></i> é‡å»ºç´¢å¼•
                        </button>
                        <button class="btn btn-outline-warning" onclick="optimizeKnowledgeBase()">
                            <i class="fas fa-compress-alt"></i> ä¼˜åŒ–å­˜å‚¨
                        </button>
                        <button class="btn btn-outline-info" onclick="validateKnowledgeBase()">
                            <i class="fas fa-check-circle"></i> éªŒè¯å®Œæ•´æ€§
                        </button>
                        <hr>
                        <button class="btn btn-outline-danger" onclick="clearKnowledgeBase()">
                            <i class="fas fa-trash"></i> æ¸…ç©ºçŸ¥è¯†åº“
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ–‡æ¡£è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="documentDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ğŸ“„ æ–‡æ¡£è¯¦æƒ…</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="documentDetailContent">
                    <!-- æ–‡æ¡£è¯¦æƒ…å†…å®¹ -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <button type="button" class="btn btn-primary" onclick="downloadDocument()">ä¸‹è½½æ–‡æ¡£</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let domainChart = null;
let currentDocuments = [];

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ§ª çŸ¥è¯†åº“é¡µé¢å¼€å§‹åŠ è½½...');
    loadKnowledgeBaseStats();
    loadDocuments();
    initWebSocket();
});

// åŠ è½½çŸ¥è¯†åº“ç»Ÿè®¡
async function loadKnowledgeBaseStats() {
    console.log('ğŸ“Š å¼€å§‹åŠ è½½çŸ¥è¯†åº“ç»Ÿè®¡...');
    try {
        const response = await fetch('/api/knowledge/stats');
        const data = await response.json();
        console.log('ğŸ“Š ç»Ÿè®¡APIå“åº”:', data);
        
        if (data.success) {
            updateStatsDisplay(data.stats);
            console.log('âœ… ç»Ÿè®¡æ•°æ®æ›´æ–°æˆåŠŸ');
        } else {
            console.warn('âš ï¸ ç»Ÿè®¡APIè¿”å›é”™è¯¯:', data.message);
            showNotification('è·å–çŸ¥è¯†åº“ç»Ÿè®¡å¤±è´¥: ' + data.message, 'warning');
        }
    } catch (error) {
        console.error('âŒ è·å–çŸ¥è¯†åº“ç»Ÿè®¡å¤±è´¥:', error);
        showNotification('è·å–çŸ¥è¯†åº“ç»Ÿè®¡å¤±è´¥', 'danger');
    }
}

// æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
function updateStatsDisplay(stats) {
    console.log('ğŸ“ˆ æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º:', stats);
    document.getElementById('totalDocuments').textContent = stats.total_documents || 0;
    document.getElementById('totalChunks').textContent = stats.total_chunks || 0;
    document.getElementById('storageSize').textContent = formatFileSize(stats.storage_size || 0);
    
    const lastUpdated = stats.last_updated ? 
        new Date(stats.last_updated).toLocaleDateString('zh-CN') : 'æœªçŸ¥';
    document.getElementById('lastUpdated').textContent = lastUpdated;
}

// åŠ è½½æ–‡æ¡£åˆ—è¡¨
async function loadDocuments() {
    console.log('ğŸ“š å¼€å§‹åŠ è½½æ–‡æ¡£åˆ—è¡¨...');
    try {
        const response = await fetch('/api/knowledge/documents');
        const data = await response.json();
        console.log('ğŸ“š æ–‡æ¡£APIå“åº”:', data);
        console.log('ğŸ“š æ–‡æ¡£æ€»æ•°:', data.total);
        console.log('ğŸ“š æ–‡æ¡£æ•°ç»„é•¿åº¦:', data.documents ? data.documents.length : 'undefined');
        
        if (data.success) {
            currentDocuments = data.documents;
            console.log('ğŸ“š ä¿å­˜åˆ°currentDocuments:', currentDocuments.length, 'ä¸ªæ–‡æ¡£');
            displayDocuments(currentDocuments);
            updateDomainChart(currentDocuments);
            console.log('âœ… æ–‡æ¡£åˆ—è¡¨å¤„ç†å®Œæˆ');
        } else {
            console.warn('âš ï¸ æ–‡æ¡£APIè¿”å›é”™è¯¯:', data.message);
            showNotification('è·å–æ–‡æ¡£åˆ—è¡¨å¤±è´¥: ' + data.message, 'warning');
            showNoDocuments();
        }
    } catch (error) {
        console.error('âŒ è·å–æ–‡æ¡£åˆ—è¡¨å¤±è´¥:', error);
        showNotification('è·å–æ–‡æ¡£åˆ—è¡¨å¤±è´¥', 'danger');
        showNoDocuments();
    }
}

// æ˜¾ç¤ºæ–‡æ¡£åˆ—è¡¨
function displayDocuments(documents) {
    console.log('ğŸ–¼ï¸ å¼€å§‹æ˜¾ç¤ºæ–‡æ¡£åˆ—è¡¨ï¼Œæ–‡æ¡£æ•°é‡:', documents ? documents.length : 'undefined');
    
    const tbody = document.getElementById('documentsTableBody');
    const noDocsDiv = document.getElementById('noDocuments');
    
    console.log('ğŸ“‹ è¡¨æ ¼å…ƒç´ :', tbody ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°');
    console.log('ğŸ“‹ æ— æ–‡æ¡£æç¤ºå…ƒç´ :', noDocsDiv ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°');
    
    if (!documents || documents.length === 0) {
        console.log('ğŸ“‹ æ–‡æ¡£åˆ—è¡¨ä¸ºç©ºï¼Œæ˜¾ç¤ºæ— æ–‡æ¡£çŠ¶æ€');
        showNoDocuments();
        return;
    }
    
    console.log('ğŸ“‹ éšè—æ— æ–‡æ¡£æç¤º');
    noDocsDiv.style.display = 'none';
    
    console.log('ğŸ“‹ å¼€å§‹ç”Ÿæˆè¡¨æ ¼HTMLï¼Œå¤„ç†', documents.length, 'ä¸ªæ–‡æ¡£');
    
    try {
        const html = documents.map((doc, index) => {
            console.log(`ğŸ“‹ å¤„ç†æ–‡æ¡£ ${index + 1}:`, doc.name, doc.id);
            return `
                <tr>
                    <td class="px-4 py-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-file-alt text-muted me-2"></i>
                            <div>
                                <div class="fw-medium">${doc.name || 'æœªçŸ¥æ–‡æ¡£'}</div>
                                <small class="text-muted">${formatFileSize(doc.size || 0)}</small>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <span class="badge bg-primary bg-opacity-10 text-primary">
                            ${getDocumentTypeLabel(doc.type)}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="badge bg-success bg-opacity-10 text-success">
                            ${getDomainLabel(doc.domain)}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <small class="text-muted">
                            ${doc.created_at ? new Date(doc.created_at).toLocaleDateString('zh-CN') : 'æœªçŸ¥'}
                        </small>
                    </td>
                    <td class="px-4 py-3">
                        <span class="badge bg-success">å·²å¤„ç†</span>
                    </td>
                    <td class="px-4 py-3">
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewDocument('${doc.id}')" title="æŸ¥çœ‹è¯¦æƒ…">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteDocument('${doc.id}')" title="åˆ é™¤">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
        console.log('ğŸ“‹ ç”Ÿæˆçš„HTMLé•¿åº¦:', html.length);
        tbody.innerHTML = html;
        console.log('âœ… è¡¨æ ¼HTMLå·²è®¾ç½®åˆ°tbody');
        
        // éªŒè¯è¡¨æ ¼æ˜¯å¦æœ‰å†…å®¹
        const rows = tbody.querySelectorAll('tr');
        console.log('ğŸ“‹ è¡¨æ ¼ä¸­çš„è¡Œæ•°:', rows.length);
        
    } catch (error) {
        console.error('âŒ ç”Ÿæˆè¡¨æ ¼HTMLæ—¶å‡ºé”™:', error);
        showNotification('æ˜¾ç¤ºæ–‡æ¡£åˆ—è¡¨æ—¶å‡ºé”™: ' + error.message, 'danger');
    }
}

// æ˜¾ç¤ºæ— æ–‡æ¡£çŠ¶æ€
function showNoDocuments() {
    document.getElementById('documentsTableBody').innerHTML = '';
    document.getElementById('noDocuments').style.display = 'block';
}

// æ›´æ–°é¢†åŸŸåˆ†å¸ƒå›¾è¡¨
function updateDomainChart(documents) {
    const domainCounts = {};
    documents.forEach(doc => {
        const domain = doc.domain || 'general';
        domainCounts[domain] = (domainCounts[domain] || 0) + 1;
    });
    
    const ctx = document.getElementById('domainChart').getContext('2d');
    
    if (domainChart) {
        domainChart.destroy();
    }
    
    domainChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(domainCounts).map(domain => getDomainLabel(domain)),
            datasets: [{
                data: Object.values(domainCounts),
                backgroundColor: [
                    '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                    '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6366f1'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// å·¥å…·å‡½æ•°
function getDocumentTypeLabel(type) {
    const types = {
        'technical_manual': 'æŠ€æœ¯æ‰‹å†Œ',
        'engineering_drawing': 'å·¥ç¨‹å›¾çº¸',
        'process_diagram': 'å·¥è‰ºæµç¨‹å›¾',
        'specification_sheet': 'æŠ€æœ¯è§„æ ¼è¡¨',
        'general': 'é€šç”¨æ–‡æ¡£'
    };
    return types[type] || type;
}

function getDomainLabel(domain) {
    const domains = {
        'mechanical': 'æœºæ¢°å·¥ç¨‹',
        'electrical': 'ç”µæ°”å·¥ç¨‹',
        'chemical': 'åŒ–å­¦å·¥ç¨‹',
        'civil': 'åœŸæœ¨å·¥ç¨‹',
        'aerospace': 'èˆªç©ºèˆªå¤©',
        'general': 'é€šç”¨é¢†åŸŸ'
    };
    return domains[domain] || domain;
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// æ“ä½œå‡½æ•°
async function refreshKnowledgeBase() {
    showNotification('æ­£åœ¨åˆ·æ–°çŸ¥è¯†åº“...', 'info');
    await loadKnowledgeBaseStats();
    await loadDocuments();
    showNotification('çŸ¥è¯†åº“å·²åˆ·æ–°', 'success');
}

function exportKnowledgeBase() {
    showNotification('å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

function rebuildIndex() {
    if (confirm('ç¡®å®šè¦é‡å»ºç´¢å¼•å—ï¼Ÿè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚')) {
        showNotification('ç´¢å¼•é‡å»ºåŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }
}

function optimizeKnowledgeBase() {
    if (confirm('ç¡®å®šè¦ä¼˜åŒ–çŸ¥è¯†åº“å­˜å‚¨å—ï¼Ÿ')) {
        showNotification('å­˜å‚¨ä¼˜åŒ–åŠŸèƒ½å¼€å‘ä¸­...', 'info');
    }
}

function validateKnowledgeBase() {
    showNotification('éªŒè¯åŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

function clearKnowledgeBase() {
    if (confirm('ç¡®å®šè¦æ¸…ç©ºæ•´ä¸ªçŸ¥è¯†åº“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        showNotification('æ¸…ç©ºåŠŸèƒ½å¼€å‘ä¸­...', 'warning');
    }
}

function filterDocuments() {
    const filter = document.getElementById('documentFilter').value;
    const filtered = filter ? 
        currentDocuments.filter(doc => doc.type === filter) : 
        currentDocuments;
    displayDocuments(filtered);
}

function searchDocuments() {
    const query = document.getElementById('documentSearch').value.toLowerCase();
    const filtered = query ? 
        currentDocuments.filter(doc => 
            (doc.name || '').toLowerCase().includes(query)
        ) : currentDocuments;
    displayDocuments(filtered);
}

function viewDocument(docId) {
    showNotification('æŸ¥çœ‹æ–‡æ¡£åŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

function deleteDocument(docId) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡æ¡£å—ï¼Ÿ')) {
        showNotification('åˆ é™¤æ–‡æ¡£åŠŸèƒ½å¼€å‘ä¸­...', 'warning');
    }
}

function downloadDocument() {
    showNotification('ä¸‹è½½åŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

// WebSocketè¿æ¥
function initWebSocket() {
    // WebSocketåŠŸèƒ½å¯ä»¥åç»­æ·»åŠ 
}
</script>
{% endblock %} 