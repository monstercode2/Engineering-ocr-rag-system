<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿè®¾ç½® - å·¥ç¨‹æ–‡æ¡£æ™ºèƒ½è§£æç³»ç»Ÿ</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        .status-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .status-card:hover {
            transform: translateY(-2px);
        }
        .status-online {
            border-left: 4px solid #28a745;
        }
        .status-offline {
            border-left: 4px solid #dc3545;
        }
        .status-warning {
            border-left: 4px solid #ffc107;
        }
        .log-container {
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        .navbar-brand {
            font-weight: 600;
        }
        .config-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            padding: 20px;
        }
    </style>
</head>
<body style="background-color: #f8f9fa;">
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-cogs me-2"></i>å·¥ç¨‹æ–‡æ¡£æ™ºèƒ½è§£æç³»ç»Ÿ
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="fas fa-home me-1"></i>é¦–é¡µ</a>
                <a class="nav-link" href="/upload"><i class="fas fa-upload me-1"></i>æ–‡æ¡£ä¸Šä¼ </a>
                <a class="nav-link" href="/chat"><i class="fas fa-comments me-1"></i>æ™ºèƒ½é—®ç­”</a>
                <a class="nav-link" href="/knowledge"><i class="fas fa-database me-1"></i>çŸ¥è¯†åº“</a>
                <a class="nav-link active" href="/settings"><i class="fas fa-cog me-1"></i>ç³»ç»Ÿè®¾ç½®</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- ç³»ç»ŸçŠ¶æ€ç›‘æ§ -->
        <div class="row mb-4">
            <div class="col-12">
                <h3><i class="fas fa-heartbeat me-2"></i>ç³»ç»ŸçŠ¶æ€ç›‘æ§</h3>
            </div>
        </div>
        
        <div class="row mb-4" id="statusCards">
            <!-- ç³»ç»ŸçŠ¶æ€å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>

        <!-- å¿«é€Ÿæ“ä½œ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="config-section">
                    <h4><i class="fas fa-bolt me-2"></i>å¿«é€Ÿæ“ä½œ</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <button class="btn btn-success w-100 mb-2" onclick="initializeSystem()">
                                <i class="fas fa-play me-2"></i>åˆå§‹åŒ–ç³»ç»Ÿ
                            </button>
                            <button class="btn btn-warning w-100 mb-2" onclick="reloadModel()">
                                <i class="fas fa-sync me-2"></i>é‡æ–°åŠ è½½æ¨¡å‹
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-info w-100 mb-2" onclick="clearCache()">
                                <i class="fas fa-broom me-2"></i>æ¸…ç†ç¼“å­˜
                            </button>
                            <button class="btn btn-secondary w-100 mb-2" onclick="exportLogs()">
                                <i class="fas fa-download me-2"></i>å¯¼å‡ºæ—¥å¿—
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- InterVLæ¨¡å‹é…ç½® -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="config-section">
                    <h4><i class="fas fa-robot me-2"></i>InterVLæ¨¡å‹é…ç½®</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">æ¨¡å‹è·¯å¾„</label>
                                <input type="text" class="form-control" id="modelPath" 
                                       value="OpenGVLab/InternVL-Chat-V1-5" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">è¿è¡Œè®¾å¤‡</label>
                                <select class="form-select" id="deviceSelect">
                                    <option value="auto">è‡ªåŠ¨æ£€æµ‹</option>
                                    <option value="cuda">GPU (CUDA)</option>
                                    <option value="cpu">CPU</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">ç²¾åº¦è®¾ç½®</label>
                                <select class="form-select" id="precisionSelect">
                                    <option value="fp16">FP16 (æ¨è)</option>
                                    <option value="fp32">FP32</option>
                                    <option value="int8">INT8</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">æœ€å¤§åˆ†è¾¨ç‡</label>
                                <input type="number" class="form-control" id="maxResolution" 
                                       value="2048" min="512" max="4096" step="256">
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="saveModelConfig()">
                        <i class="fas fa-save me-2"></i>ä¿å­˜é…ç½®
                    </button>
                </div>
            </div>
        </div>

        <!-- RAGFlowé…ç½® -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="config-section">
                    <h4><i class="fas fa-database me-2"></i>RAGFlowé…ç½®</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">RAGFlow URL</label>
                                <input type="text" class="form-control" id="ragflowUrl" 
                                       value="http://localhost:9380" placeholder="http://localhost:9380">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">APIå¯†é’¥</label>
                                <input type="password" class="form-control" id="ragflowApiKey" 
                                       placeholder="è¯·è¾“å…¥RAGFlow APIå¯†é’¥">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">é»˜è®¤çŸ¥è¯†åº“</label>
                                <input type="text" class="form-control" id="defaultKb" 
                                       value="å·¥ç¨‹æ–‡æ¡£çŸ¥è¯†åº“" placeholder="çŸ¥è¯†åº“åç§°">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">è¿æ¥è¶…æ—¶ (ç§’)</label>
                                <input type="number" class="form-control" id="ragflowTimeout" 
                                       value="30" min="5" max="120">
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="saveRagflowConfig()">
                        <i class="fas fa-save me-2"></i>ä¿å­˜é…ç½®
                    </button>
                    <button class="btn btn-outline-secondary ms-2" onclick="testRagflowConnection()">
                        <i class="fas fa-plug me-2"></i>æµ‹è¯•è¿æ¥
                    </button>
                </div>
            </div>
        </div>

        <!-- ç³»ç»Ÿæ—¥å¿— -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="config-section">
                    <h4><i class="fas fa-file-alt me-2"></i>ç³»ç»Ÿæ—¥å¿— 
                        <button class="btn btn-sm btn-outline-secondary float-end" onclick="refreshLogs()">
                            <i class="fas fa-sync me-1"></i>åˆ·æ–°
                        </button>
                    </h4>
                    <div class="log-container bg-dark text-light p-3 rounded" id="logContainer">
                        <div class="text-muted">æ­£åœ¨åŠ è½½æ—¥å¿—...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrapå’Œè‡ªå®šä¹‰è„šæœ¬ -->
    <script src="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        const socket = io();
        
        // é¡µé¢åŠ è½½æ—¶è·å–ç³»ç»ŸçŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            loadSystemStatus();
            loadSystemLogs();
            loadConfigurations();
        });
        
        // åŠ è½½ç³»ç»ŸçŠ¶æ€
        function loadSystemStatus() {
            fetch('/api/system/status')
                .then(response => response.json())
                .then(data => {
                    updateStatusCards(data);
                })
                .catch(error => {
                    console.error('è·å–ç³»ç»ŸçŠ¶æ€å¤±è´¥:', error);
                    showToast('è·å–ç³»ç»ŸçŠ¶æ€å¤±è´¥', 'error');
                });
        }
        
        // æ›´æ–°çŠ¶æ€å¡ç‰‡
        function updateStatusCards(status) {
            const cards = [
                {
                    title: 'InterVL OCR',
                    status: status.ocr_manager ? 'online' : 'offline',
                    icon: 'fas fa-eye',
                    description: status.ocr_manager ? 'æ¨¡å‹å·²åŠ è½½' : 'æ¨¡å‹æœªåŠ è½½'
                },
                {
                    title: 'RAGFlow',
                    status: status.ragflow_adapter ? 'online' : 'offline',
                    icon: 'fas fa-database',
                    description: status.ragflow_adapter ? 'è¿æ¥æ­£å¸¸' : 'æœªè¿æ¥'
                },
                {
                    title: 'çŸ¥è¯†åº“',
                    status: status.ragflow?.knowledge_base ? 'online' : 'warning',
                    icon: 'fas fa-book',
                    description: status.ragflow?.knowledge_base ? 'è¿è¡Œæ­£å¸¸' : 'å¾…é…ç½®'
                },
                {
                    title: 'WebæœåŠ¡',
                    status: 'online',
                    icon: 'fas fa-globe',
                    description: 'æœåŠ¡è¿è¡Œä¸­'
                }
            ];
            
            const container = document.getElementById('statusCards');
            container.innerHTML = cards.map(card => `
                <div class="col-md-3">
                    <div class="card status-card status-${card.status}">
                        <div class="card-body text-center">
                            <i class="${card.icon} fa-2x mb-2 text-${getStatusColor(card.status)}"></i>
                            <h5 class="card-title">${card.title}</h5>
                            <p class="card-text text-muted small">${card.description}</p>
                            <span class="badge bg-${getStatusColor(card.status)}">${getStatusText(card.status)}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function getStatusColor(status) {
            switch(status) {
                case 'online': return 'success';
                case 'offline': return 'danger';
                case 'warning': return 'warning';
                default: return 'secondary';
            }
        }
        
        function getStatusText(status) {
            switch(status) {
                case 'online': return 'åœ¨çº¿';
                case 'offline': return 'ç¦»çº¿';
                case 'warning': return 'è­¦å‘Š';
                default: return 'æœªçŸ¥';
            }
        }
        
        // ç³»ç»Ÿæ“ä½œå‡½æ•°
        function initializeSystem() {
            showToast('æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ...', 'info');
            fetch('/api/system/init', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ', 'success');
                        loadSystemStatus();
                    } else {
                        showToast('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥', 'error');
                    }
                })
                .catch(error => {
                    showToast('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
                });
        }
        
        function reloadModel() {
            showToast('åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }
        
        function clearCache() {
            showToast('åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }
        
        function exportLogs() {
            showToast('åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }
        
        function saveModelConfig() {
            showToast('æ¨¡å‹é…ç½®å·²ä¿å­˜', 'success');
        }
        
        function saveRagflowConfig() {
            showToast('RAGFlowé…ç½®å·²ä¿å­˜', 'success');
        }
        
        function testRagflowConnection() {
            showToast('æ­£åœ¨æµ‹è¯•è¿æ¥...', 'info');
            // TODO: å®ç°è¿æ¥æµ‹è¯•
            setTimeout(() => {
                showToast('è¿æ¥æµ‹è¯•å®Œæˆ', 'success');
            }, 2000);
        }
        
        function loadSystemLogs() {
            // æ¨¡æ‹Ÿæ—¥å¿—å†…å®¹
            const logs = [
                '[2025-05-31 19:51:33] INFO - ğŸš€ å¼€å§‹åˆå§‹åŒ–ç³»ç»Ÿ...',
                '[2025-05-31 19:51:33] INFO - âš™ï¸ æ­£åœ¨åˆå§‹åŒ–InterVL OCRç®¡ç†å™¨...',
                '[2025-05-31 19:51:33] INFO - ğŸ“¦ æ­£åœ¨åŠ è½½InterVLæ¨¡å‹...',
                '[2025-05-31 19:51:47] WARNING - âš ï¸ InterVLæ¨¡å‹åŠ è½½å¤±è´¥: Tokenizer class Qwen2Tokenizer does not exist',
                '[2025-05-31 19:51:47] INFO - ğŸ’¡ ç³»ç»Ÿå°†ä»¥é™çº§æ¨¡å¼è¿è¡Œï¼ŒOCRåŠŸèƒ½æš‚ä¸å¯ç”¨',
                '[2025-05-31 19:51:47] INFO - ğŸ”§ æ­£åœ¨åˆå§‹åŒ–RAGFlowé€‚é…å™¨...',
                '[2025-05-31 19:51:47] INFO - âœ… RAGFlowé€‚é…å™¨åˆå§‹åŒ–æˆåŠŸ',
                '[2025-05-31 19:51:47] INFO - ğŸ‰ ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼æ ¸å¿ƒç»„ä»¶å·²å°±ç»ª'
            ];
            
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = logs.map(log => {
                let className = 'text-light';
                if (log.includes('ERROR') || log.includes('âŒ')) className = 'text-danger';
                else if (log.includes('WARNING') || log.includes('âš ï¸')) className = 'text-warning';
                else if (log.includes('SUCCESS') || log.includes('âœ…')) className = 'text-success';
                else if (log.includes('INFO') || log.includes('â„¹ï¸')) className = 'text-info';
                
                return `<div class="${className}">${log}</div>`;
            }).join('');
            
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function refreshLogs() {
            loadSystemLogs();
            showToast('æ—¥å¿—å·²åˆ·æ–°', 'success');
        }
        
        function loadConfigurations() {
            // è¿™é‡Œå¯ä»¥ä»åç«¯åŠ è½½å®é™…é…ç½®
        }
        
        // å·¥å…·å‡½æ•°
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer') || createToastContainer();
            const toastId = 'toast-' + Date.now();
            
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }
        
        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            container.style.zIndex = '1055';
            document.body.appendChild(container);
            return container;
        }
        
        // å®šæœŸåˆ·æ–°çŠ¶æ€
        setInterval(loadSystemStatus, 30000); // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡
    </script>
</body>
</html> 