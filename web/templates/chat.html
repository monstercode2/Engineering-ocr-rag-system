{% extends "base.html" %}

{% block title %}æ™ºèƒ½é—®ç­” - å·¥ç¨‹æ–‡æ¡£æ™ºèƒ½è§£æä¸RAGé—®ç­”ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <!-- èŠå¤©ä¸»ç•Œé¢ -->
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-robot me-2"></i>
                    å·¥ç¨‹æ™ºèƒ½åŠ©æ‰‹
                </h5>
                <div>
                    <button class="btn btn-sm btn-outline-secondary me-2" onclick="clearChat()">
                        <i class="fas fa-trash me-1"></i>æ¸…ç©ºå¯¹è¯
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="exportChat()">
                        <i class="fas fa-download me-1"></i>å¯¼å‡ºå¯¹è¯
                    </button>
                </div>
            </div>
            <div class="card-body p-0 d-flex flex-column" style="height: 600px;">
                <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
                <div class="chat-container flex-grow-1" id="chatContainer">
                    <!-- æ¬¢è¿æ¶ˆæ¯ -->
                    <div class="message system">
                        <i class="fas fa-robot me-2"></i>
                        æ¬¢è¿ä½¿ç”¨å·¥ç¨‹æ™ºèƒ½åŠ©æ‰‹ï¼æˆ‘å¯ä»¥å¸®æ‚¨è§£ç­”å·¥ç¨‹æŠ€æœ¯é—®é¢˜ã€‚
                    </div>
                </div>
                
                <!-- è¾“å…¥åŒºåŸŸ -->
                <div class="p-3 border-top bg-light">
                    <div class="input-group">
                        <input type="text" class="form-control" id="messageInput" 
                               placeholder="è¯·è¾“å…¥æ‚¨çš„æŠ€æœ¯é—®é¢˜..." 
                               onkeypress="handleKeyPress(event)">
                        <button class="btn btn-primary" type="button" onclick="sendMessage()" id="sendBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    
                    <!-- å¿«æ·é—®é¢˜ -->
                    <div class="mt-2">
                        <small class="text-muted">å¿«æ·é—®é¢˜ï¼š</small>
                        <div class="mt-1">
                            <button class="btn btn-sm btn-outline-secondary me-1 mb-1" onclick="askQuickQuestion('è¿™ä¸ªè®¾å¤‡çš„å·¥ä½œå‹åŠ›æ˜¯å¤šå°‘ï¼Ÿ')">
                                å·¥ä½œå‹åŠ›
                            </button>
                            <button class="btn btn-sm btn-outline-secondary me-1 mb-1" onclick="askQuickQuestion('ææ–™çš„å¼ºåº¦ç­‰çº§è¦æ±‚æ˜¯ä»€ä¹ˆï¼Ÿ')">
                                ææ–™å¼ºåº¦
                            </button>
                            <button class="btn btn-sm btn-outline-secondary me-1 mb-1" onclick="askQuickQuestion('å·¥è‰ºæµç¨‹çš„æ¸©åº¦æ§åˆ¶èŒƒå›´ï¼Ÿ')">
                                æ¸©åº¦æ§åˆ¶
                            </button>
                            <button class="btn btn-sm btn-outline-secondary me-1 mb-1" onclick="askQuickQuestion('ç›¸å…³çš„æŠ€æœ¯æ ‡å‡†æœ‰å“ªäº›ï¼Ÿ')">
                                æŠ€æœ¯æ ‡å‡†
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- ä¾§è¾¹æ  -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    ç³»ç»ŸçŠ¶æ€
                </h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>RAGå¼•æ“:</span>
                    <span class="badge bg-success" id="ragStatus">è¿è¡Œä¸­</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>çŸ¥è¯†åº“æ–‡æ¡£:</span>
                    <span class="badge bg-info" id="docCount">0</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span>å“åº”æ—¶é—´:</span>
                    <span class="badge bg-secondary" id="responseTime">--</span>
                </div>
            </div>
        </div>
        
        <!-- å¯¹è¯å†å² -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-history me-2"></i>
                    å¯¹è¯ç»Ÿè®¡
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4">
                        <div class="h5 mb-0" id="messageCount">0</div>
                        <small class="text-muted">æ¶ˆæ¯æ•°</small>
                    </div>
                    <div class="col-4">
                        <div class="h5 mb-0" id="sessionTime">0:00</div>
                        <small class="text-muted">ä¼šè¯æ—¶é•¿</small>
                    </div>
                    <div class="col-4">
                        <div class="h5 mb-0" id="avgResponseTime">--</div>
                        <small class="text-muted">å¹³å‡å“åº”</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ä½¿ç”¨æç¤º -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>
                    ä½¿ç”¨æç¤º
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled small">
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        è¯¢é—®å…·ä½“çš„æŠ€æœ¯å‚æ•°å’Œè§„æ ¼
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        æé—®å·¥è‰ºæµç¨‹å’Œæ“ä½œæ­¥éª¤
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        æŸ¥è¯¢å®‰å…¨æ ‡å‡†å’Œè§„èŒƒè¦æ±‚
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        æ”¯æŒå¤šè½®å¯¹è¯å’Œä¸Šä¸‹æ–‡ç†è§£
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // å…¨å±€å˜é‡
    let sessionId = generateSessionId();
    let messageCount = 0;
    let sessionStartTime = Date.now();
    let responseTimes = [];
    let isProcessing = false;
    
    // ç”Ÿæˆä¼šè¯ID
    function generateSessionId() {
        return 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    // å¤„ç†å›è½¦é”®
    function handleKeyPress(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    }
    
    // å‘é€æ¶ˆæ¯
    async function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        
        if (!message || isProcessing) return;
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        input.value = '';
        
        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
        addMessage('user', message);
        
        // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
        showTypingIndicator();
        
        // è®¾ç½®å¤„ç†çŠ¶æ€
        isProcessing = true;
        updateSendButton(true);
        
        const startTime = Date.now();
        
        try {
            // å‘é€APIè¯·æ±‚
            const response = await apiRequest('/api/chat/query', {
                method: 'POST',
                body: JSON.stringify({
                    question: message,
                    session_id: sessionId
                })
            });
            
            const endTime = Date.now();
            const responseTime = endTime - startTime;
            responseTimes.push(responseTime);
            
            // éšè—æ‰“å­—æŒ‡ç¤ºå™¨
            hideTypingIndicator();
            
            if (response.success) {
                // æ·»åŠ åŠ©æ‰‹å›å¤
                addMessage('assistant', response.answer, {
                    confidence: response.confidence,
                    sources: response.sources,
                    processing_time: responseTime
                });
                
                // æ›´æ–°å“åº”æ—¶é—´æ˜¾ç¤º
                updateResponseTime(responseTime);
            } else {
                addMessage('system', 'æŠ±æ­‰ï¼Œå¤„ç†æ‚¨çš„é—®é¢˜æ—¶å‡ºç°é”™è¯¯ã€‚è¯·ç¨åå†è¯•ã€‚');
            }
            
        } catch (error) {
            hideTypingIndicator();
            addMessage('system', `è¿æ¥é”™è¯¯: ${error.message}`);
        } finally {
            isProcessing = false;
            updateSendButton(false);
            updateStatistics();
        }
    }
    
    // å¿«æ·é—®é¢˜
    function askQuickQuestion(question) {
        const input = document.getElementById('messageInput');
        input.value = question;
        sendMessage();
    }
    
    // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
    function addMessage(type, content, metadata = {}) {
        const container = document.getElementById('chatContainer');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        
        let messageHTML = '';
        
        if (type === 'user') {
            messageHTML = `
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <strong>æ‚¨</strong>
                    <small class="text-muted">${formatTime(new Date())}</small>
                </div>
                <div>${escapeHtml(content)}</div>
            `;
        } else if (type === 'assistant') {
            messageHTML = `
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <strong><i class="fas fa-robot me-1"></i>åŠ©æ‰‹</strong>
                    <small class="text-muted">${formatTime(new Date())}</small>
                </div>
                <div class="mb-2">${escapeHtml(content)}</div>
            `;
            
            // æ·»åŠ å…ƒæ•°æ®ä¿¡æ¯
            if (metadata.confidence !== undefined) {
                messageHTML += `
                    <div class="mt-2 pt-2 border-top">
                        <small class="text-muted">
                            <i class="fas fa-chart-line me-1"></i>ç½®ä¿¡åº¦: ${(metadata.confidence * 100).toFixed(1)}%
                            <span class="ms-3">
                                <i class="fas fa-clock me-1"></i>å“åº”æ—¶é—´: ${metadata.processing_time}ms
                            </span>
                        </small>
                    </div>
                `;
            }
            
            if (metadata.sources && metadata.sources.length > 0) {
                messageHTML += `
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-book me-1"></i>å‚è€ƒæ¥æº: ${metadata.sources.length}ä¸ªæ–‡æ¡£
                        </small>
                    </div>
                `;
            }
        } else if (type === 'system') {
            messageHTML = `
                <div class="text-center">
                    <i class="fas fa-info-circle me-1"></i>
                    ${escapeHtml(content)}
                </div>
            `;
        }
        
        messageDiv.innerHTML = messageHTML;
        container.appendChild(messageDiv);
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        container.scrollTop = container.scrollHeight;
        
        // æ›´æ–°æ¶ˆæ¯è®¡æ•°
        messageCount++;
    }
    
    // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
    function showTypingIndicator() {
        const container = document.getElementById('chatContainer');
        const typingDiv = document.createElement('div');
        typingDiv.id = 'typingIndicator';
        typingDiv.className = 'typing-indicator';
        typingDiv.innerHTML = `
            <div class="d-flex align-items-center">
                <small class="text-muted me-2">åŠ©æ‰‹æ­£åœ¨æ€è€ƒ</small>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        `;
        container.appendChild(typingDiv);
        container.scrollTop = container.scrollHeight;
    }
    
    // éšè—æ‰“å­—æŒ‡ç¤ºå™¨
    function hideTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) {
            indicator.remove();
        }
    }
    
    // æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
    function updateSendButton(processing) {
        const btn = document.getElementById('sendBtn');
        if (processing) {
            btn.disabled = true;
            btn.innerHTML = '<div class="loading"></div>';
        } else {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane"></i>';
        }
    }
    
    // æ›´æ–°å“åº”æ—¶é—´æ˜¾ç¤º
    function updateResponseTime(time) {
        document.getElementById('responseTime').textContent = time + 'ms';
        
        const avgTime = responseTimes.reduce((a, b) => a + b, 0) / responseTimes.length;
        document.getElementById('avgResponseTime').textContent = Math.round(avgTime) + 'ms';
    }
    
    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStatistics() {
        document.getElementById('messageCount').textContent = messageCount;
        
        const sessionDuration = Date.now() - sessionStartTime;
        const minutes = Math.floor(sessionDuration / 60000);
        const seconds = Math.floor((sessionDuration % 60000) / 1000);
        document.getElementById('sessionTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // æ¸…ç©ºå¯¹è¯
    function clearChat() {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¯¹è¯è®°å½•å—ï¼Ÿ')) {
            const container = document.getElementById('chatContainer');
            container.innerHTML = `
                <div class="message system">
                    <i class="fas fa-robot me-2"></i>
                    æ¬¢è¿ä½¿ç”¨å·¥ç¨‹æ™ºèƒ½åŠ©æ‰‹ï¼æˆ‘å¯ä»¥å¸®æ‚¨è§£ç­”å·¥ç¨‹æŠ€æœ¯é—®é¢˜ã€‚
                </div>
            `;
            
            // é‡ç½®ç»Ÿè®¡
            messageCount = 0;
            sessionStartTime = Date.now();
            responseTimes = [];
            sessionId = generateSessionId();
            
            updateStatistics();
            document.getElementById('responseTime').textContent = '--';
            document.getElementById('avgResponseTime').textContent = '--';
            
            showNotification('å¯¹è¯å·²æ¸…ç©º', 'info');
        }
    }
    
    // å¯¼å‡ºå¯¹è¯
    function exportChat() {
        const messages = document.querySelectorAll('.message');
        let content = '# å·¥ç¨‹æ™ºèƒ½åŠ©æ‰‹å¯¹è¯è®°å½•\n\n';
        content += `**ä¼šè¯ID**: ${sessionId}\n`;
        content += `**å¯¼å‡ºæ—¶é—´**: ${formatTime(new Date())}\n\n`;
        content += '---\n\n';
        
        messages.forEach((msg, index) => {
            const type = msg.classList.contains('user') ? 'ğŸ‘¤ ç”¨æˆ·' : 
                        msg.classList.contains('assistant') ? 'ğŸ¤– åŠ©æ‰‹' : 'ğŸ’¡ ç³»ç»Ÿ';
            const text = msg.textContent.trim();
            content += `## ${index + 1}. ${type}\n\n${text}\n\n---\n\n`;
        });
        
        const blob = new Blob([content], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `chat_${sessionId}.md`;
        a.click();
        URL.revokeObjectURL(url);
        
        showNotification('å¯¹è¯è®°å½•å·²å¯¼å‡º', 'success');
    }
    
    // æ›´æ–°ç³»ç»ŸçŠ¶æ€
    async function updateSystemStatus() {
        try {
            const status = await apiRequest('/api/system/status');
            
            // æ›´æ–°RAGçŠ¶æ€
            const ragStatus = document.getElementById('ragStatus');
            if (status.ragflow_adapter) {
                ragStatus.textContent = 'è¿è¡Œä¸­';
                ragStatus.className = 'badge bg-success';
            } else {
                ragStatus.textContent = 'æœªåˆå§‹åŒ–';
                ragStatus.className = 'badge bg-danger';
            }
            
            // æ›´æ–°çŸ¥è¯†åº“æ–‡æ¡£æ•°
            try {
                const stats = await apiRequest('/api/knowledge/stats');
                if (stats.success && stats.stats) {
                    document.getElementById('docCount').textContent = stats.stats.total_documents || 0;
                }
            } catch (error) {
                console.log('è·å–çŸ¥è¯†åº“ç»Ÿè®¡å¤±è´¥:', error);
            }
            
        } catch (error) {
            console.error('æ›´æ–°ç³»ç»ŸçŠ¶æ€å¤±è´¥:', error);
        }
    }
    
    // å·¥å…·å‡½æ•°
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function formatTime(date) {
        return date.toLocaleTimeString('zh-CN', { 
            hour: '2-digit', 
            minute: '2-digit', 
            second: '2-digit' 
        });
    }
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        // æ›´æ–°ç³»ç»ŸçŠ¶æ€
        updateSystemStatus();
        
        // è®¾ç½®å®šæ—¶å™¨æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        setInterval(updateStatistics, 1000);
        
        // å®šæœŸæ›´æ–°ç³»ç»ŸçŠ¶æ€
        setInterval(updateSystemStatus, 30000);
        
        // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
        document.getElementById('messageInput').focus();
    });
    
    // WebSocketäº‹ä»¶å¤„ç†
    if (socket) {
        socket.on('chat_response', function(data) {
            console.log('æ”¶åˆ°WebSocketå“åº”:', data);
        });
    }
</script>
{% endblock %} 